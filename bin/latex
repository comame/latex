#!/bin/sh

watchFile() {
    WATCHFILE_FILENAME=$1
    shift

    WATCHFILE_COMMAND=""
    while [ $# -gt 0 ]
    do
        WATCHFILE_COMMAND="$WATCHFILE_COMMAND $1"
        shift
    done

    eval $WATCHFILE_COMMAND
    WATCHFILE_LAST=`openssl sha256 -r $WATCHFILE_FILENAME | awk '{print $1}'`
    while true; do
        sleep 0.1
        WATCHFILE_CURRENT=`openssl sha256 -r $WATCHFILE_FILENAME | awk '{print $1}'`
        if [ "$WATCHFILE_LAST" != "$WATCHFILE_CURRENT" ]; then
            eval $WATCHFILE_COMMAND
            WATCHFILE_LAST=$WATCHFILE_CURRENT
        fi
    done
}

printHelp() {
    printf "%s\n" \
        "" \
        "latex [OPTIONS] [<FILENAME>]" \
        "" \
        "<FILENAME> は拡張子を含まない .tex ファイルのファイル名" \
        "" \
        "Options:" \
        "  -w, --watch    ファイルの更新時に再コンパイルする" \
        "  -h, --help     ヘルプを表示する" \
        ""
}

set -e

### Handle parameters and options

OPTIONS=$(getopt -n latex -o wh -l watch,help -- "$@")
eval set -- $OPTIONS

OPT_WATCH=0
OPT_HELP=0

while [ $# -gt 0 ]
do
    case $1 in
        -w) OPT_WATCH=1;;
        --watch) OPT_WATCH=1;;
        -h) OPT_HELP=1;;
        --help) OPT_HELP=1;;
        --) shift; break;
    esac
    shift
done

ARG_FILENAME=""

while [ $# -gt 0 ]
do
    ARG_FILENAME=$1
    break;
done


### Main

if [ $OPT_HELP -ne 0 ]; then
    printHelp
    exit 0
fi

ENTRYPOINT="docker run --rm -v $(pwd):/home/user comameito/latex"
FILENAME="doc"

COMMAND=""

if [ "$ARG_FILENAME" = "" ]; then
    FILENAME="doc"
else
    FILENAME=$ARG_FILENAME
fi

if [ ! -e "$FILENAME.tex" ]; then
    echo "latex: file $FILENAME.tex not found in this directory" 1>&2
    exit 1
fi

if [ $OPT_WATCH -eq 0 ]; then
    COMMAND="$ENTRYPOINT $FILENAME"
else
    COMMAND="watchFile $FILENAME.tex $ENTRYPOINT $FILENAME"
fi

eval $COMMAND
