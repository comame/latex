#!/usr/bin/bash

watchFile() {
    eval ${@:2}
    last=`openssl sha256 -r $1 | awk '{print $1}'`
    while true; do
        sleep 0.5
        current=`openssl sha256 -r $1 | awk '{print $1}'`
        if [ "$last" != "$current" ]; then
            eval ${@:2}
            last=$current
        fi
    done
}

printHelp() {
    printf "%s\n" \
        "" \
        "latex [OPTIONS] [<FILENAME>]" \
        "" \
        "<FILENAME> は拡張子を含まない .tex ファイルのファイル名" \
        "" \
        "Options:" \
        "  -w, --watch    ファイルの更新時に再コンパイルする" \
        "  -h, --help     ヘルプを表示する" \
        ""
}

set -e

### Handle parameters and options

OPTIONS=$(getopt -n latex -o wh -l watch,help -- "$@")
eval set -- $OPTIONS

OPT_WATCH=0
OPT_HELP=0

while [ $# -gt 0 ]
do
    case $1 in
        -w) OPT_WATCH=1;;
        --watch) OPT_WATCH=1;;
        -h) OPT_HELP=1;;
        --help) OPT_HELP=1;;
        --) shift; break;
    esac
    shift
done

ARG_FILENAME=""

while [ $# -gt 0 ]
do
    ARG_FILENAME=$1
    break;
done


### Main

if [ $OPT_HELP -ne 0 ]; then
    printHelp
    exit 0
fi

ENTRYPOINT="docker run --rm -v $(pwd):/home/user comameito/latex"
FILENAME="doc"

COMMAND=""

if [ "$ARG_FILENAME" = "" ]; then
    FILENAME="doc"
else
    FILENAME=$ARG_FILENAME
fi

if [ $OPT_WATCH -eq 0 ]; then
    COMMAND="$ENTRYPOINT $FILENAME"
else
    COMMAND="watchFile $FILENAME.tex $ENTRYPOINT $FILENAME"
fi

eval $COMMAND
